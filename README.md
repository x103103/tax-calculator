# Poland Tax Calculator

A Node.js application that calculates Polish income tax on stock trading profits according to 2025 tax law. Automatically handles USD to PLN conversion using official NBP exchange rates.

## Features

- **Automated Tax Calculation**: Calculates 19% tax on net trading profits
- **Currency Conversion**: Converts USD amounts to PLN using previous-day exchange rates
- **Fee Handling**: Accounts for buy and sell commissions
- **FIFO Method**: Uses First-In-First-Out for position matching

## Formula

```
Tax = ((Profits) - (Buy Fees) - (Sell Fees)) × 19%
```

## Setup

Install dependencies:

```bash
pnpm install
```

## Usage

### Calculate Tax (CLI)

**Development (with ts-node):**
```bash
pnpm run dev
```

**Production (compiled):**
```bash
pnpm run build
pnpm start
```

### Programmatic Usage

**TypeScript:**
```typescript
import { generateReport } from './app/application';
import type { TaxReport } from './app/types';

async function main(): Promise<void> {
  const report: TaxReport = await generateReport();
  console.log(`Tax Owed: ${report.taxOwed.toFixed(2)} PLN`);
}

main();
```

**JavaScript (compiled from dist/):**
```javascript
const { generateReport } = require('./dist/application');

async function main() {
  const report = await generateReport();
  console.log(`Tax Owed: ${report.taxOwed.toFixed(2)} PLN`);
}

main();
```

### Run Tests

```bash
pnpm test                  # Run all tests
pnpm run test:watch        # Watch mode
pnpm run test:coverage     # With coverage report
pnpm run type-check        # Type check without building
```

## Architecture

The v2 architecture follows Clean Architecture principles with clear separation of concerns:

### Layered Structure

```
┌─────────────────────────────────────────┐
│      Presentation Layer (CLI/API)       │  ← User interfaces
├─────────────────────────────────────────┤
│       Application Layer (Use Cases)     │  ← Orchestration
├─────────────────────────────────────────┤
│     Domain Layer (Business Logic)       │  ← Pure logic, no I/O
├─────────────────────────────────────────┤
│  Infrastructure Layer (Data/Services)   │  ← External dependencies
└─────────────────────────────────────────┘
```

### Directory Structure

```
app/
├── types/                       # TypeScript type definitions
│   └── index.ts                 # All interfaces & types
│
├── domain/                      # Business logic (framework-agnostic)
│   ├── calculators/
│   │   ├── profit-calculator.ts
│   │   ├── buy-fee-calculator.ts
│   │   ├── sell-fee-calculator.ts
│   │   └── tax-calculator.ts
│   ├── services/
│   │   └── currency-converter.ts
│   └── __tests__/
│
├── application/                 # Use cases & orchestration
│   ├── calculate-tax/
│   │   ├── calculator.ts
│   │   ├── index.ts
│   │   └── __tests__/
│   └── index.ts
│
├── infrastructure/              # External dependencies
│   ├── data/
│   │   ├── csv-loader.ts
│   │   └── __tests__/
│   ├── repositories/
│   │   ├── trade-repository.ts
│   │   └── __tests__/
│   └── services/
│       ├── usd-pln-rate/
│       │   ├── rate-service.ts
│       │   ├── index.ts
│       │   └── __tests__/
│       └── google-sheets/       # Google Sheets utility (JS)
│
├── presentation/                # User interfaces
│   ├── cli/
│   │   ├── console-reporter.ts
│   │   └── index.ts
│   └── api/                     # Future: REST API
│
├── config/
│   ├── default-config.ts
│   └── index.ts
│
└── test-poland-tax.ts           # CLI entry point

dist/                            # Compiled output (generated by npm run build)
tsconfig.json                    # TypeScript config
jest.config.ts                   # Jest config with ts-jest preset
```

### Design Principles

**1. Dependency Inversion**
- Domain layer has no dependencies
- Infrastructure injects into application
- Configuration via constructor injection

**2. Single Responsibility**
- Each file handles one concern
- Calculators are pure functions
- Repositories handle data access only

**3. Testability**
- 84 tests with 99.48% statement coverage
- Mocked dependencies in tests
- Integration tests with fixtures

**4. Type Safety**
- Written in 100% TypeScript with strict mode enabled
- Comprehensive type definitions in `app/types/index.ts`
- All function signatures fully typed
- Service interfaces enforce contracts (IRateService, ITradeRepository)

**5. Extensibility**
The architecture supports future extensions:

**Adding REST API:**
```typescript
// app/presentation/api/routes/tax.ts
import { calculateTax } from '../../../application';
import type { ConfigOverrides, TaxSummary } from '../../../types';

router.post('/calculate-tax', async (req, res) => {
  const result: TaxSummary = await calculateTax(req.body.config);
  res.json(result);
});
```

**Adding Database:**
```typescript
// app/infrastructure/database/trade-repository.ts
import type { ITradeRepository, TradeData, TradeRepositoryConfig } from '../../../types';

class DbTradeRepository implements ITradeRepository {
  async load(config: TradeRepositoryConfig): Promise<TradeData> {
    // Query PostgreSQL instead of CSV
    return { closedPositions, buyTradesMap, sellTrades };
  }
}
```

**Adding Web UI:**
- Create `app/presentation/ui/` with Next.js/Remix
- Call same application layer APIs
- Type safety with exported type definitions
- No domain/application changes needed

## TypeScript

Project uses TypeScript with strict mode for full type safety.

### Key Types

Core types defined in `app/types/index.ts`:

- **CSV Types**: `ClosedPositionRow`, `TradeRow`, `RateRow`
- **Domain Types**: `ProfitDetail`, `FeeDetail`, `ProfitResult`, `FeeResult`, `ConversionResult`
- **Config Types**: `TaxConfig`, `CsvPaths`, `ConfigOverrides`
- **Report Types**: `TaxSummary`, `TaxReport`
- **Service Interfaces**: `IRateService`, `ITradeRepository`

### Build & Development

**Development mode** (watches TS files, uses ts-node):
```bash
pnpm run dev
```

**Type checking** (without building):
```bash
pnpm run type-check
```

**Production build** (compiles to dist/):
```bash
pnpm run build
pnpm start
```

### Configuration

- **tsconfig.json**: ES2022 target, CommonJS modules, strict mode
- **jest.config.ts**: Configured for TypeScript with ts-jest
- **Source maps**: Generated for debugging compiled code

## Data Sources

The calculator requires 4 CSV files in `tmp/data/spreadsheet-tabs/`:

1. **closed_2025.csv** - Closed positions with realized P&L
2. **trades_2024.csv** - Buy transactions from 2024
3. **trades_2025.csv** - Buy and sell transactions from 2025
4. **rates.csv** - Daily USD/PLN exchange rates

All files are synced from Google Sheets using the fetch script (see below).

### Fetching Data from Google Spreadsheet

To sync the latest data from Google Sheets:

```bash
node fetch-all-tabs.js
```

This downloads all tabs from the spreadsheet and saves them as CSV files.

### Manual Google Spreadsheet CSV Fetch

```typescript
import { fetchGoogleSheetAsCSV } from './app/infrastructure/services/google-sheets';

// Get the spreadsheet ID from the Google Sheets URL
// https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit#gid=SHEET_ID
const spreadsheetId = 'YOUR_SPREADSHEET_ID';
const gid = '0'; // Optional: specific sheet ID (default is first sheet)

try {
  const csvData = await fetchGoogleSheetAsCSV(spreadsheetId, gid);
  console.log('CSV Data:', csvData);
  // Process your CSV data here
} catch (err) {
  console.error('Error:', err);
}
```

### Important Notes

- The Google Spreadsheet must be publicly accessible or shared with "anyone with the link"
- The `spreadsheetId` is the long string in the URL between `/d/` and `/edit`
- The `gid` parameter is optional and refers to a specific sheet within the spreadsheet (default is '0' for the first sheet)

## Requirements

- **Node.js**: 24.13.0 LTS (managed via asdf)
- **pnpm**: 10.28.0
- **TypeScript**: 5.9.3+
- **Runtime**: CommonJS
- **Dependencies**:
  - axios (HTTP requests)
  - jest (testing)
  - ts-jest (TypeScript test execution)
  - ts-node (development runtime)
